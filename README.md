# micro-cardservice

Credit card and customer microservice built with Quarkus.
This project exposes endpoints for customer registration, card creation,
purchase registration, and invoice retrieval/payment.
It also includes a Ledger core (double-entry, idempotent postings) isolated from
the card domain.

## Stack
- Java 21
- Quarkus 3.3.1
- Hibernate ORM + Panache
- H2 (in-memory)
- MapStruct
- Maven

## Requirements
- Java 21+
- Maven (or use the repo Maven Wrapper)

## Run (dev)
```bash
./mvnw quarkus:dev
```
On Windows:
```bat
mvnw.cmd quarkus:dev
```

By default the API runs at:
```
http://localhost:8080
```

## Endpoints (main)

### Customers (requires `X-API-Key` â†’ tenant resolution)
- `POST /customers`  
  Body (JSON):
```json
{
  "type": "INDIVIDUAL",
  "name": "Joao da Silva",
  "documentType": "CPF",
  "documentNumber": "12345678900"
}
```
  Response `201 Created` with customer data (id, status, createdAt).

- `GET /customers/{customerId}`  
  Returns `200` with the customer or `401/404` as applicable.

- `GET /customers?documentType=CPF&documentNumber=12345678900&page=0&size=20`  
  Searches by document; returns a paged `items[]` list (empty when not found). Defaults: `page=0`, `size=20`. Missing document params returns an empty page.

### Cards
- `POST /cartoes`  
  Body (JSON) expected by the use case:
```json
{
  "bandeira": "Mastercard",
  "nomeTitular": "Joao da Silva",
  "cvv": "123",
  "clienteId": "11111111-1111-1111-1111-111111111111"
}
```
Card number, expiry date, and limits are generated by the service.

### Transactions (purchases)
- `POST /transacoes`  
  Body (JSON):
```json
{
  "descricao": "Purchase at the market",
  "valor": 100.00,
  "dataHora": "2024-01-15T10:30:00",
  "cartaoId": "22222222-2222-2222-2222-222222222222"
}
```

### Invoice
- `GET /fatura/{ano}/{mes}`  
  Example: `/fatura/2024/01`

- `POST /fatura/transacao`  
  Body (JSON) is the same as transaction.

- `POST /fatura/pagar/{ano}/{mes}`  
  Marks the invoice as paid.

### Ledger (requires `X-Tenant-Id`)
Ledger is append-only and validates double-entry per currency.
Posting is idempotent via `idempotencyKey`.
If `X-Tenant-Id` is absent the API returns `400`.

- `POST /ledger/accounts`  
  Body (JSON):
```json
{
  "name": "Customer Wallet",
  "type": "ASSET",
  "currency": "BRL",
  "allowNegative": false
}
```
Response:
```json
{ "accountId": "33333333-3333-3333-3333-333333333333" }
```

- `POST /ledger/transactions`  
  Body (JSON):
```json
{
  "idempotencyKey": "card-txn-123",
  "externalReference": "cardTxnId-123",
  "description": "Merchant purchase",
  "occurredAt": "2026-01-24T10:00:00Z",
  "entries": [
    { "accountId": "A1", "direction": "DEBIT",  "amountMinor": 10000, "currency": "BRL" },
    { "accountId": "A2", "direction": "CREDIT", "amountMinor": 10000, "currency": "BRL" }
  ]
}
```
Response:
```json
{ "transactionId": "44444444-4444-4444-4444-444444444444" }
```

- `GET /ledger/accounts/{id}/balance`  
  Response:
```json
{ "accountId": "A1", "balanceMinor": 25000, "currency": "BRL" }
```

- `GET /ledger/accounts/{id}/statement?from=&to=&page=&size=`  
  Response:
```json
{
  "accountId": "A1",
  "items": [
    {
      "occurredAt": "2026-01-24T10:00:00Z",
      "transactionId": "44444444-4444-4444-4444-444444444444",
      "description": "Merchant purchase",
      "direction": "DEBIT",
      "amountMinor": 10000,
      "currency": "BRL"
    }
  ],
  "page": 0,
  "size": 20,
  "total": 123
}
```

## Tests
```bash
./mvnw test
```

## Configuration
Main settings live in:
- `src/main/resources/application.properties`
- `src/test/resources/application.properties`

The database is H2 in-memory with `drop-and-create`.

## Docs
- Ledger specification: `docs/especificacao_nucleo_ledger_separado_do_dominio_de_cartao.md`
- Multi-tenant extension: `docs/especificacao_extensao_multi_tenant_para_o_ledger_core.md`
